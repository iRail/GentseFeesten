<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>Gentse Feesten</title>
		<meta name="description" content="" />
		<meta name="author" content="Dimitri Roose" />
		<meta name="author" content="Pieter Colpaert" />
		<meta name="author" content="Tim Besard" />

		<!-- <meta name="viewport" content="width=device-width; initial-scale=1.0" /> -->

		<!-- Replace favicon.ico & apple-touch-icon.png in the root of your domain and delete these references -->
		<!-- <link rel="shortcut icon" href="/favicon.ico" /> -->
		<!-- <link rel="apple-touch-icon" href="/apple-touch-icon.png" /> -->

		<link type="text/css" rel="stylesheet" href="css/jquery.mobile-1.0b1.css" />
		<script type="text/javascript" src="js/modernizr-2.0.6.js"></script>
		<script type="text/javascript" src="js/jquery-1.6.2.js"></script>
		<script type="text/javascript" src="js/jquery.mobile-1.0b1.js"></script>	
		<script type="text/javascript" src="js/gentsefeesten.js"></script>
		<script type="text/javascript">
		//
		// Static data
		//
		
		var mHasLocation = false
		var mLatitude, mLongitude
		
		var mHasEvents
		var mEvents
		
		var mRadius = 2
		
		
		//
		// Auxiliary
		//
		
		function readableDistance(iMeters) {
			if (iMeters > 1000) {
				var tKilometers = iMeters/1000
				return Math.round(tKilometers*100)/100 + " km"
			}
			return Math.round(iMeters) + " m"
		}
		
		
		//
		// UI creation
		//
		
		function populateList() {
			if (mHasLocation && mHasEvents) {
				// Filter the events
				var date = new Date();
				tEventPartitions = GentseFeesten.filterEvents(mEvents, mLatitude, mLongitude, mRadius, date.getHours())
				
				// Populate the events (quite brute for now)
				var t = $('#events li.template')
				$.each(tEventPartitions, function(tPartitionIndex, tPartition) {
					var tPartitionItem = $('#listDivider').clone();
					tPartitionItem.attr('id', 'divider_' + tPartitionIndex);
					$(".title", tPartitionItem).text(tPartitionIndex+date.getHours()-1);
					$(".counter", tPartitionItem).text(tPartition.length);
					tPartitionItem.appendTo($('#events'));
					
					$.each(tPartition, function (tEventIndex, tEvent) {
						var tEventItem = $('#item').clone();
						tEventItem.attr('id', 'event_' + tPartitionIndex + '_' + tEventIndex);
						$('#title', tEventItem).text(tEvent.title);
						$('#start', tEventItem).text(tEvent.schedule.start);
						$('.location .description', tEventItem).text(tEvent.location.description)
						$('.location .distance', tEventItem).text(readableDistance(1000*tEvent.location.distance) + " van hier")
						$('a', tEventItem).attr('href', '#page');				
						tEventItem.appendTo($('#events'));
					});
				});
				$('#listDivider').remove();
				$('#item').remove();
			}
		}
		
		
		//
		// Main
		//
		
		$('document').ready(function() {
			// Load the data when a page is about to be shown
			$('#home[data-role=page]').live('pageshow',function(iEvent, iUi) {
				// Request the current location
				GentseFeesten.getLocation(
					function onLocationSuccess(iLatitude, iLongitude, iAccuracy) {
						mLatitude = iLatitude
						mLongitude = iLongitude
						mHasLocation = true
						
						GentseFeesten.getAddressByLocation(
							mLatitude,
							mLongitude,
							function(iAddress) {
								$('#location_status').text("(" + iAddress + ")");
							},
							function(iError) {
								$('#location_status').text("(kem u gevonden)");
							}
						);
			
						populateList();
					},
					function (error) {
						$('#location_status').text("(kvind u ni, zeg het mij es)");
				});
				
				// Request a list of events
				var date = new Date();
				GentseFeesten.getEvents(
					date.getDate() - 15 + 1,	// FIXME: +1 for development purposes
					function(iEvents) {
						mEvents = iEvents
						mHasEvents = true
		
						populateList();
					},
					function(error) {
						alert(error);		
				});
			});
			// Catch an address specification
			var t = $('#location_address');
			$('#location_address').keypress(function(iEvent) {
				if (iEvent.which == 13) {
					GentseFeesten.getLocationByAddress(
						$('#location_address').val(),
						function(iLatitude, iLongitude, iFormattedAddress) {
							mHasLocation = true
							mLatitude = iLatitude
							mLongitude = iLongitude
							$('#location_status').text("(" + iFormattedAddress + ")");
							populateList()
						}, function(iError) {
							$('#location_status').text("(ksnap der niks van, probeert nog es)");
						}
					);
				}
			});
		});
		</script>
	</head>
	<body>
		<div id="home" data-role="page">

			<div data-role="header">
				<h1>Gentse Feesten</h1>
			</div>

			<div id="divContent" data-role="content">
				<div data-role="collapsible" data-collapsed="true">
					<h3 id="locationheader">Locatie <i id="location_status">(aant zoeken...)</i></h3>
					<div data-role="fieldcontain">
						<input type="text" placeholder="Waar zijt ge..." id="location_address" value="" />
					</div>
				</div>
				<ul id="events" data-role="listview" data-inset="true" class="ui-listview  ui-listview-inset ui-corner-all ui-shadow " data-theme="c" data-dividertheme="b">
					<li id="listDivider" class="ui-li ui-li-divider ui-btn ui-bar-b ui-btn-up-undefined" role="heading" data-role="list-divider">
						<span class="title"></span>
						<span class="counter ui-li-count ui-btn-up-c ui-btn-corner-all"></span>
					</li>
					<li id="item" class="ui-btn-corner-none ui-btn-icon-right ui-li ui-btn-up-c" data-theme="c">
						<div class="ui-btn-inner ui-li">
							<div class="ui-btn-text">
								<a class="ui-link-inherit" href="">
								<p class="ui-li-aside ui-li-desc">
									<strong id="start"></strong>
								</p>

								<h3 id="title"></h3>
								<p>
									<strong class="location" >
										<span class="description"> </span>
										<i> (<span class="distance"> </span>)</i>
									</strong>
								</p>
								</a>
							</div>
						</div>
					</li>
				</ul>
			</div>

			<div data-role="footer">
				<h4></h4>
			</div>
		</div>

		<div id="location" data-role="page">

			<div data-role="header">
				<h1>Location</h1>
			</div>

			<div data-role="content">
			</div>
		</div>

		<div id="event" data-role="page">

			<div data-role="header">
				
			</div>

			<div data-role="content">
			</div>
		</div>
	</body>
</html>
