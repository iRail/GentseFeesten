<!DOCTYPE html>
<html lang="nl" manifest="manifest.appcache">
	<head>
		<meta charset="utf-8" />

		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

		<title>Gentse Feesten</title>
		<meta name="description" content="" />
		<meta name="author" content="Dimitri Roose" />
		<meta name="author" content="Pieter Colpaert" />
		<meta name="author" content="Tim Besard" />

		<!-- as not every OS supports HTML-less icon detection, provide this in details, and link to imgage dir instead of root -->
		
		<!-- 1. iPhone 4/retina --> 
		<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/gentsefeesten.png">
		<!-- iPad G1 -->
		<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/gentsefeesten.png">
		<!-- non-retina iPhone, iPod Touch, Android 2.1+ -->
		<link rel="apple-touch-icon-precomposed" sizes="57x57" href="/gentsefeesten.png">
		<!-- everything else, provider higher resolution img -->
		<link rel="apple-touch-icon-precomposed" href="/gentsefeesten.png">

		<meta name="viewport" content="width=device-width; initial-scale=1.0" />

		<link type="text/css" rel="stylesheet" href="css/jquery.mobile-1.0b1.css" />
		<script type="text/javascript" src="js/modernizr-2.0.6.js"></script>
		<script type="text/javascript" src="js/jquery-1.6.2.js"></script>
		<script type="text/javascript" src="js/jquery.mobile-1.0b1.js"></script>
		<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
		<script type="text/javascript" src="js/gentsefeesten.js"></script>
		<script type="text/javascript">

		//
		// Static data
		//
		
		var mHasLocation = false
		var mLatitude, mLongitude
		
		var mHasEvents
		var mEvents
		
		var mRadius = 2
		
		var mCurrentEvent
		
		//
		// Auxiliary
		//
		
		function readableDistance(iMeters) {
			if (iMeters > 1000) {
				var tKilometers = iMeters/1000
				return Math.round(tKilometers*100)/100 + " km"
			}
			return Math.round(iMeters) + " m"
		}
		
		
		//
		// UI creation
		//
		
		function populateList() {
			if (mHasLocation && mHasEvents) {
				// Filter the events
				var date = new Date();
				tEventPartitions = GentseFeesten.filterEvents(mEvents, mLatitude, mLongitude, mRadius, date.getHours())
				
				// Populate the events (quite brute for now)
				var t = $('#events li.template')
				$.each(tEventPartitions, function(tPartitionIndex, tPartition) {
					if (tPartition.length > 0) {
						var tPartitionItem = $('#listDivider').clone();
						tPartitionItem.attr('id', 'divider_' + tPartitionIndex);
						$(".title", tPartitionItem).text('Achter ' + (tPartitionIndex+date.getHours()-1) + " uur");
						$(".counter", tPartitionItem).text(tPartition.length + " events");
						tPartitionItem.appendTo($('#events'));
					
						$.each(tPartition, function (tEventIndex, tEvent) {
							var tEventItem = $('#item').clone();
							tEventItem.attr('id', 'event_' + tPartitionIndex + '_' + tEventIndex);
							$('#title', tEventItem).text(tEvent.title);
							$('#start', tEventItem).text(tEvent.schedule.start);
							$('.location .description', tEventItem).text(tEvent.location.description)
							$('.location .distance', tEventItem).text(readableDistance(1000*tEvent.location.distance) + " van hier")
							$('a', tEventItem).attr('href', '#event');
							$('a', tEventItem).click( function() {
								mCurrentEvent = JSON.stringify(tEvent);
								populateEvent();
							});
							tEventItem.appendTo($('#events'));
						});
					}
				});
				$('#listDivider').remove();
				$('#item').remove();
				$('#events').attr("style", "")
			}
		}
		
		function populateEvent() {
			if(mCurrentEvent){
				$('#eventDetails').empty();
				var tCurrentEvent = $.parseJSON(mCurrentEvent);
				$('<h3>').text(tCurrentEvent.title).appendTo('#eventDetails');
				$('<p>').text(tCurrentEvent.description).appendTo('#eventDetails');
				$('<h4>').text('Locatie').appendTo('#eventDetails');
				$('<p>').text(tCurrentEvent.location.description).appendTo('#eventDetails');
				$('<h4>').text('Tijdstip').appendTo('#eventDetails');
				$('<p>').text('Van ' + tCurrentEvent.schedule.start + ' tot ' + tCurrentEvent.schedule.stop + '.').appendTo('#eventDetails');
			}
		}
		
		
		//
		// Main
		//
		
		$('document').ready(function() {

//check the appcache
window.applicationCache.addEventListener('updateready', function(e) {
    if (window.applicationCache.status == window.applicationCache.UPDATEREADY) {
      // Browser downloaded a new app cache.
      // Swap it in and reload the page to get the new hotness.
      window.applicationCache.swapCache();
      if (confirm('Der es een nieuwe versie beschikboar. Magk u browser herladen?')) {
        window.location.reload();
      }
    } else {
      // Manifest didn't changed. Nothing new to server.
    }
  }, false);

			// Request the current location
			GentseFeesten.getLocation(
				function onLocationSuccess(iLatitude, iLongitude, iAccuracy) {
					mLatitude = iLatitude
					mLongitude = iLongitude
					mHasLocation = true
					
					$('#location_status').text(" (kem u gevonden)");
					GentseFeesten.getAddressByLocation(
						mLatitude,
						mLongitude,
						function(iAddress) {
                         			        $('#location_status_div').trigger("collapse");
							$('#location_status').text("(" + iAddress + ")");
						},
						function(iError) {
							$('#location_status').text(" (kem u gevonden, ma kweet ni waar)");
						}
					);
		
					populateList();
				},
				function (error) {
					$('#location_status').text("(kvind u ni, zeg het mij es)");
               			        $('#location_status_div').trigger("expand");
			});
			
			// Request a list of events
			var date = new Date();
			GentseFeesten.getEvents(
				date.getDate() - 15,	// FIXED +1
				function(iEvents) {
					mEvents = iEvents
					mHasEvents = true
	
					populateList();
				},
				function(error) {
					alert("Oeie, tmarcheert precies ni...");
			});
			
			// Catch an address specification
			var t = $('#location_address');
		});
		
		function searchLocation() {
			GentseFeesten.getLocationByAddress(
				$('#location_address').val(),
				function(iLatitude, iLongitude, iFormattedAddress) {
					mHasLocation = true
					mLatitude = iLatitude
					mLongitude = iLongitude
					$('#location_status').text("(" + iFormattedAddress + ")");
					populateList()
				}, function(iError) {
					$('#location_status').text("(ksnap der niks van, probeert nog ne kier)");
				}
			);
		}

	$('#location_address').keyup(function(event) {
			      if ( event.which == 13 ) {
			      searchLocation();
			      }

	});

//disable enter through forms
    $("#formwaarzijtge").keypress(function(e) {
    if (e.which == 13) {
    searchLocation();
    }
    });
// Catch an address specification

		
		</script>
	</head>
	<body>
		<div id="home" data-role="page">

			<div data-role="header">
				<a href="javascript:window.location.reload()" class="ui-btn-left" data-icon="refresh">Herladen</a>
				<h1>Gentse Feesten</h1>
				<a href="#about" class="ui-btn-right" data-icon="info">Informoasje</a>
			</div>

			<div id="divContent" data-role="content">
				<div data-role="collapsible" data-collapsed="true" id="location_status_div">
					<h3 id="locationheader">Mijn plekske <i id="location_status">(aant zoeken...)</i></h3>
					<div data-role="fieldcontain">
						<form action="javascript: return false" method="post" id="formwaarzijtge">
							<input type="text" placeholder="Waar zijt ge..." id="location_address" value="" />
							<input id="clickme" type="button" value="Vint da ne kier" onclick="javascript:searchLocation()"/>
						</form>
					</div>
				</div>
				<ul id="events" data-role="listview" data-inset="true" class="ui-listview  ui-listview-inset ui-corner-all ui-shadow " data-theme="c" data-dividertheme="b" style="visibility: hidden;">
					<li id="listDivider" class="ui-li ui-li-divider ui-btn ui-bar-b ui-btn-up-undefined" role="heading" data-role="list-divider">
						<span class="title"></span>
						<span class="counter ui-li-count ui-btn-up-c ui-btn-corner-all"></span>
					</li>
					<li id="item" class="ui-btn-corner-none ui-btn-icon-right ui-li ui-btn-up-c" data-theme="c">
						<div class="ui-btn-inner ui-li">
							<div class="ui-btn-text">
								<a class="ui-link-inherit" href="">
								<p class="ui-li-aside ui-li-desc">
									<strong id="start"></strong>
								</p>

								<h3 id="title"></h3>
								<p>
									<strong class="location" >
										<span class="description"> </span>
										<i> (<span class="distance"> </span>)</i>
									</strong>
								</p>
								</a>
							</div>
						</div>
					</li>
				</ul>
			</div>

			<div data-role="footer">
			  <p align="center">
			    <small>&copy; 2011 <a href="http://npo.iRail.be" target="_blank">iRail vzw/asbl</a> - Sommige rechten veurbehouden</small>
			  </p>
			</div>
		</div>

		<div id="event" data-role="page">

			<div data-role="header">
				<a href='#' class='ui-btn-left' data-icon='arrow-l' onclick="history.back(); return false">Back</a><h1>Details</h1>			
			</div>

			<div id="eventDetails" data-role="content">
			</div>

			<div data-role="footer">
			  <p align="center">
			    <small>&copy; 2011 <a href="http://npo.iRail.be" target="_blank">iRail vzw/asbl</a> - Sommige rechten veurbehouden</small>
			  </p>
			</div>
		</div>

		<div id="about" data-role="page">

			<div data-role="header">
				<a href='#' class='ui-btn-left' data-icon='arrow-l' onclick="history.back(); return false">Back</a>
				<h1>Over ons</h1>			
			</div>

			<div data-role="content">
			  <ul>
			    <li>Vertoald door <a href="http://www.twitter.com/BartRosseau" target="_blank">Bart Rosseau</a> - Ambtenaar 2.0</li>
			    <li>Uitgewerkt tijdens <a href="http://www.summerofcode.be" target="_blank">iRail Summer of Code</a></li>
			    <li>Open source: <a href="http://github.com/iRail/GentseFeesten/" target="_blank">broncode</a></li>
			    <li>Auteurs:
			      <ul>
				<li>Dimitri Roose - dimitri at iRail.be</li>
				<li>Tim Besard - tim at iRail.be</li>
				<li>Pieter Colpaert - pieter at iRail.be</li>
			    </ul></li>
			    <li>Met dank aan Stad Gent en iedereen die zijn steentje bijdroeg tot het openen van deze data</li>
			  </ul>
			</div>

			<div data-role="footer">
			  <p align="center">
			    <small>&copy; 2011 <a href="http://npo.iRail.be" target="_blank">iRail vzw/asbl</a> - Sommige rechten veurbehouden</small>
			  </p>
			</div>
		</div>
	</body>
</html>
